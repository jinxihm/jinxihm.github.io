<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="description" content="a test space">
<meta name="author" content="fangliang">
<title>My blog</title>

<link href="resources/bootstrap331dist/css/bootstrap.css" rel="stylesheet">
<link href="resources/octicons/octicons.css" rel="stylesheet">
<link href="resources/foundation-icons/foundation-icons.css" rel="stylesheet">
<!-- icons -->
<!-- <link href="resources/css/wowblog.css" rel="stylesheet"> -->
<!-- icons -->

<!-- make IE8 support HTML5 elements and media queries -->
<!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

<script src="resources/jquery/jquery-1.11.1.min.js"></script>
<script src="resources/bootstrap331dist/js/bootstrap.min.js"></script>
<script src="resources/avos/av-mini.js"></script>



<!-- Local JavaScript -->



<style>

.dashboard-left {
float: left;
display:none;
width: 290px;
}

.content-main {
float: left;
width: 590px;
margin: 0px 0px 0px 10px;
}

.dashboard-right {
float: left;
display:none;
width: 290px;
margin: 0px 0px 0px 10px;
}


.wrapper {
width: 600px;
position: relative;
margin: 0 auto;
}

@media (min-width: 992px){
  .wrapper {
  width: 890px;
  }
  .dashboard-left{
  display:block;
  }
}

@media (min-width: 1236px){
  .wrapper {
  width: 1190px;
  }
  .dashboard-right{
  display:block;
  }
}

.cc-item{
border-bottom:1px solid #e1e8ed;
padding-top:8px;
padding-left:30px;
padding-right:10px;
padding-bottom:20px;
}



.cc-box{
margin: 0px 0px 10px 0px;

background-color: #fff;

border-radius: 3px;
font-size: 14px;
padding: 8px 10px;
min-height:32px;
}
.cc-box:after{
clear:both;
}

#newCcBox{
border: 1px solid #e1e8ed;
outline: 0;
}

#topicPanel{
min-height:100px;
padding-right:30px;

}

#topicPanel span{
color:#0084B4;
margin-right:20px;
display: inline-block;
line-height: 25px;
padding:0 10px;
}
#topicPanel span:hover{
cursor:pointer;
/*background-color:#F5F5F5;*/
background-color:#B7B7B7;
color:white;

}

</style>


<script>




$(document).ready(function(){
	
	
	
	
	AV.initialize('wooqq9lzgy9oav8z2w3z3catseza9pcivkveazkglzqyndw6', '7v81oyhqpkxwis3x5bykesmcxgjihspz38wrp51fbe2pdpdk');
	// Declare the types.
	var Post = AV.Object.extend('Post');
	var Comment = AV.Object.extend('Comment');
	var Topic = AV.Object.extend('Topic');
	
	
	var query = new AV.Query(Post);
	query.descending('createdTime');
	query.find({
	  success: function(results) {
	    
	    // Do something with the returned AV.Object values
	    for (var i = 0; i < results.length; i++) {
	    	if(i>10) break;
	      var object = results[i];
	      loadCc(object.get('html'));
	    }
	  },
	  error: function(error) {
		  console.log("Error: " + error.code + " " + error.message);
	  }
	});

	
	function loadCc(html){
	/* 	var ccItem = $('#ccItemTempl').clone().removeAttr('id');
		ccItem.find('.cc-box').html(html);
		ccItem.after('#ccItemTempl').show(); */
		
		var item = $('<div class="cc-item"><div class="cc-box"></div></div>').appendTo('#ccItemList');
		item.find('.cc-box').html(html);
		
	}
	
	
	$('#newCcBox').focus(function(){
		$('#newCcPlaceholder').remove();
		$('#newCcBox').css("min-height","100px");
		$('#ccBoxFooter').show();
	});
	
	
	
	
	$('#newCcBox').blur(function(){
		var text = $(this).text();
		var html = $(this).html();
		if(text.trim() === "" && html.indexOf('<img>') < 0){			
			//$('#newCcBox').append('<div id="newCcPlaceholder">有什么想法？</div>')
			$('<div id="newCcPlaceholder">有什么想法？</div>').appendTo('#newCcBox').hide();
			var codeToExec = "$('#ccBoxFooter').hide();$('#newCcBox').css('min-height','32px');$('#newCcPlaceholder').show()";
			setTimeout(codeToExec,90);			
			
		}		
	});
	
	$('#newCcBox').keyup(function(e){
		if($(this).text().trim() === ""){
			$('#sendCcBtn').prop('disabled', true);
		}else{
			$('#sendCcBtn').prop('disabled', false);
			if(e.ctrlKey && e.which == 13){
				$('#sendCcBtn').click();
			}
		}		 
	});
	
	$('#sendCcBtn').click(function(){
		var post = new Post();
		var text = $('#newCcBox').text();
		var html = $('#newCcBox').html();
		post.set('text', text);
		post.set('html', html);
		post.set('createdTime', (new Date()).getTime());

		post.save(null, {
			success: function(post){				
				$('#newCcBox').html('').blur();
				
				var item = $('<div class="cc-item"><div class="cc-box"></div></div>').insertAfter('#newCcItem');
				item.find('.cc-box').html(html);
				
				// 符合该正则表达式的文字为主题
				var reg = /#\S{1,15}#/g;
				var topics = text.match(reg);
				if(topics && topics.length > 0){
					saveTopic(topics, post.id);
				}
			},
			error: function(post, error){
				console.log('Failed to create new object, with error code: ' + error.description);
			}
		});
		
	});
	
	function saveTopic(topics, postId){
		
		    if(topics.length == 0){
		    	return;
		    }
			// 取最后一个,并去除前后#号
			var topicName = topics.pop().slice(1,-1);
			var query = new AV.Query(Topic);
			query.equalTo('name', topicName);
			query.find().then(function(results){
				debugger;
				// topic已存在
				if(results !== null && results.length > 0){
					var topic = results[0];
					topic.add('postId', postId);
					topic.set('postNum', (topic.get('postNum') || 0) + 1);
					return topic.save();
				// topic不存在
				}else{
					var topic = new Topic();
					topic.set('name', topicName);
					topic.set('postId',[postId]);
					topic.set('postNum', 1);
					return topic.save(null,{success: function(topic){
						debugger;
						console.log('create new topic succeed: ' + topic.id);
					}});
				}
			}).then(function(){
				console.log("save topic succeed");
				// 递归调用
				return saveTopic(topics, postId)
			},function(error){
				console.log("save topic error");
				console.log("Error: " + error.code + " " + error.message);
			}).then(function(){
				// 查询主题标签
				var topicQuery = new AV.Query(Topic);
				topicQuery.descending('postNum');
				return topicQuery.find();
			}).then(function(allTopics){
				// 更新标签面板
				debugger;
				$('#topicPanel').empty();
				for(var i = 0; i<allTopics.length; i++){
					
					$('<span>#' + allTopics[i].get('name') + '#</span>').appendTo('#topicPanel');
				}
			},function(error){
				console.log("query all topic error");
				console.log("Error: " + error.code + " " + error.message);
			});

	}
	
	function initTopic(){
		var topicQuery = new AV.Query(Topic);
		topicQuery.descending('postNum');
		topicQuery.find().then(function(allTopics){
			// 更新标签面板
			debugger;
			for(var i = 0; i<allTopics.length; i++){
				
				$('<span>#' + allTopics[i].get('name') + '#</span>').appendTo('#topicPanel');
			}
		},function(error){
			console.log("init topic error");
			console.log("Error: " + error.code + " " + error.message);
		});
	};
	
	initTopic();
	
		
	
	
});// end of ready



</script>

<style>




</style>


</head>
<body style="padding-top:58px;background-image:url(http://www.cloud7.com.cn/Themes/Cloud7Global/Styles/Images/block01-bg.jpg)"> 


  <div class="wrapper">
    <div class="dashboard-left">
      <div class="panel panel-default" >
          <div class="panel-body" style="min-height:100px">
           lz楼主比较懒
                                      不喜欢写长篇大作
                                       但经常冒出一些想法
          </div>
         </div>
         
         <div class="panel panel-default">
          <input placeholder="search here">
         </div>
         
         <div class="panel panel-default" >
          <div class="panel-body" id="topicPanel">
            <!-- <a>#足迹#</a> -->           
          </div>
         </div>
    
    </div>
    <div class="content-main">
      <div class="panel panel-default cc-list" id="ccItemList">
          <div class="cc-item" id="newCcItem" >
               <div class="cc-box" id="newCcBox" contentEditable=true>
                  <div id="newCcPlaceholder">有什么想法？</div>
               </div>
               <div id="ccBoxFooter" style="display:none">
                  <button type="button" class="btn btn-default" style="border:0px">拍照</button>
                  <button type="button" class="btn btn-default" style="border:0px">添加链接</button>
                  <button type="button" class="btn btn-default" style="border:0px">地理位置</button>
                  <button id="sendCcBtn" disabled type="button" class="btn btn-success" style="float:right;margin-right:18px">&nbsp;保&nbsp;存&nbsp;</button>
               </div>
            </div>              
        </div>    
    </div>
    <div class="dashboard-right">
    
        
        
        <div class="panel panel-default" >
          <div class="panel-body" style="min-height:200px">
            todo list
          </div>
        </div>
        
        <div class="panel panel-default">
          <div class="panel-body" style="min-height:100px">
            tomato GTD
          </div>
        </div>
    </div>
  </div>






</body>
</html>